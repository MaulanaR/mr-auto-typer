name: Release Build

on:
  push:
    tags:
      - 'v*.*.*' # Push events to matching v*, i.e. v1.0.0

env:
  APP_NAME: mr-auto-typer
  NODE_OPTIONS: "--max-old-space-size=4096" # Necessary for most environments as build failure can occur due to OOM issues

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            ext: ''
            arch: amd64
          - os: windows-latest
            platform: windows
            ext: .exe
            arch: amd64

    steps:
      - name: Install Wails dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build frontend
        if: hashFiles('frontend/package.json') != ''
        working-directory: frontend
        run: |
          npm ci
          npm run build 2>/dev/null || echo "No build script found, skipping frontend build"

      - name: Build Wails
        uses: dAppServer/wails-build-action@v2.2
        with:
          build-platform: ${{ matrix.platform }}/amd64
          go-version: '1.23'
          build-ldflags: "-X main.version=${GITHUB_REF_NAME}"

      - name: Package Linux artifact
        if: matrix.platform == 'linux'
        run: |
          mkdir -p dist
          BIN_NAME="${APP_NAME}"
          
          if [ -f "build/bin/${BIN_NAME}" ]; then
            cp "build/bin/${BIN_NAME}" "dist/"
            tar -czf "dist/${APP_NAME}-${GITHUB_REF_NAME}-linux-${{ matrix.arch }}.tar.gz" -C "dist" "${BIN_NAME}"
            rm "dist/${BIN_NAME}"
          else
            echo "Linux binary not found"
            find build -type f -name "*" || true
            exit 1
          fi
          ls -lah dist/

      - name: Package Windows artifact
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $BIN_NAME = "${env:APP_NAME}${{ matrix.ext }}"
          $exePath = "build/bin/${BIN_NAME}"
          
          if (Test-Path $exePath) {
            Compress-Archive -Path $exePath -DestinationPath "dist/${env:APP_NAME}-${env:GITHUB_REF_NAME}-windows-${{ matrix.arch }}.zip"
          } else {
            Write-Host "Binary not found at $exePath"
            Get-ChildItem -Path build/bin -Recurse -Force | Out-String
            exit 1
          }
          Get-ChildItem dist


      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 1

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_dist
          merge-multiple: true

      - name: Create Release Notes
        id: create_release_notes
        run: |
          echo "## Release ${{ github.ref_name }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### Downloads" >> release_notes.md
          echo "" >> release_notes.md
          for file in release_dist/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              echo "- \`${filename}\` (${size})" >> release_notes.md
            fi
          done
          echo "" >> release_notes.md
          echo "Full Changelog: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}" >> release_notes.md
          cat release_notes.md
          echo "release_notes=$(cat release_notes.md)" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.create_release_notes.outputs.release_notes }}
          files: release_dist/*
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
